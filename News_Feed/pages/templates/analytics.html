{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  body {
    background: #f4f6f9;
    font-family: 'Segoe UI', sans-serif;
  }
  .card {
    box-shadow: 0 0 20px rgba(0,0,0,0.05);
    border: none;
    border-radius: 1rem;
    margin-bottom: 2rem;
  }
  .chart-container {
    position: relative;
    height: 400px;
  }
</style>

<div class="container-fluid mt-5" id="report-content">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Analytics Overview</h2>
    <button class="btn btn-success" onclick="downloadPDF()">Download Report</button>
  </div>

  <!-- Summary Cards -->
  <div class="row">
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <h6>Total Users</h6>
        <h2>{{ total_users }}</h2>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <h6>New Users (24hrs)</h6>
        <h2>{{ new_users_24hrs }}</h2>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <h6>Dormant Users</h6>
        <h2>{{ dormant_users_count }}</h2>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <h6>Top Category</h6>
        <h2>{{ category_with_most_likes }}</h2>
      </div>
    </div>
  </div>

 <!-- Top Posts Section -->
<div class="row">
  <div class="col-md-6">
    <div class="card p-3">
      <h6>Most Liked Post</h6>
      {% if most_liked_post %}
        <p>{{ most_liked_post.title }}</p>
      {% else %}
        <p><em>No data available</em></p>
      {% endif %}
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3">
      <h6>Least Liked Post</h6>
      {% if least_liked_post %}
        <p>{{ least_liked_post.title }}</p>
      {% else %}
        <p><em>No data available</em></p>
      {% endif %}
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3">
      <h6>Most Saved Post</h6>
      {% if most_saved_post %}
        <p>{{ most_saved_post.title }}</p>
      {% else %}
        <p><em>No data available</em></p>
      {% endif %}
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3">
      <h6>Least Saved Post</h6>
      {% if least_saved_post %}
        <p>{{ least_saved_post.title }}</p>
      {% else %}
        <p><em>No data available</em></p>
      {% endif %}
    </div>
  </div>
</div>


  <!-- Top Users -->
  <div class="row">
    <div class="col-md-6">
      <div class="card p-3">
        <h6>Top Liker</h6>
        <p>{{ top_liker }}</p>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h6>Top Saver</h6>
        <p>{{ top_saver }}</p>
      </div>
    </div>
  </div>

  <!-- Category Likes Chart (Image) -->
  <div class="card p-4">
    <h5 class="mb-3">Top 5 Categories by Likes</h5>
    <img src="{{ chart_path }}" class="img-fluid" alt="Category Likes Chart">
  </div>

  <!-- Dynamic Chart Section -->
  <div class="card p-4 mt-4">
    <div class="d-flex justify-content-between align-items-center">
      <h5>Interactive Analytics (Filtered)</h5>
      <select id="periodSelect" class="form-select w-auto" onchange="fetchAnalytics()">
        <option value="7">Last 7 Days</option>
        <option value="14">Last 14 Days</option>
        <option value="30">Last 30 Days</option>
      </select>
    </div>
    <div class="row mt-4">
      <div class="col-md-4 chart-container"><canvas id="likesChart"></canvas></div>
      <div class="col-md-4 chart-container"><canvas id="commentsChart"></canvas></div>
      <div class="col-md-4 chart-container"><canvas id="savesChart"></canvas></div>
    </div>
  </div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
function fetchAnalytics() {
  const period = document.getElementById("periodSelect").value;
  fetch(`/get-analytics-data?period=${period}`)
    .then(res => res.json())
    .then(data => {
      renderChart('likesChart', data.most_liked, 'Most Liked Posts');
      renderChart('commentsChart', data.most_commented, 'Most Commented Posts');
      renderChart('savesChart', data.most_saved, 'Most Saved Posts');
    });
}

function renderChart(canvasId, data, label) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (window[canvasId + 'Chart']) window[canvasId + 'Chart'].destroy();
  window[canvasId + 'Chart'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(d => d['post__title']),
      datasets: [{
        label: label,
        data: data.map(d => d.total),
        backgroundColor: 'rgba(23, 162, 184, 0.7)',
        borderColor: 'rgba(23, 162, 184, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      indexAxis: 'y',
      scales: {
        x: { beginAtZero: true }
      }
    }
  });
}
document.addEventListener("DOMContentLoaded", function () {
  window.downloadPDF = function () {
    const report = document.getElementById("report-content").cloneNode(true);

    // Replace canvases with static images
    report.querySelectorAll('canvas').forEach(canvas => {
      const img = document.createElement('img');
      img.src = canvas.toDataURL("image/png");
      img.style.maxWidth = "100%";
      canvas.replaceWith(img);
    });

    // Optional: Remove dropdowns or elements that shouldnâ€™t appear
    report.querySelectorAll('select').forEach(el => el.remove());

    const opt = {
      margin: 0.5,
      filename: 'analytics_report.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    setTimeout(() => {
      html2pdf().set(opt).from(report).save();
    }, 500); // slight delay to allow DOM processing
  };
});

// Initial load
fetchAnalytics();
</script>
{% endblock %}
